# Multi-package project Makefile script.
.POSIX:
help:

#MAKE = make # (GNU make variants: make (Linux) gmake (FreeBSD)

parent = {{parentcap}}{{^parentcap}}Introcs{{/parentcap}}
version = {{version}}{{^version}}0.1.0{{/version}}
SUBDIRS = common app

.PHONY: setup configure all testcompile help clean check restore nugetadd nugetinstall
setup configure: $(SUBDIRS) ## [setup | configure] [OPTS=""]
	-for dirX in $^ ; do mkdir -p $$dirX/build ; \
		(cd $$dirX ; meson $@ $(OPTS) build) ; done
help: $(SUBDIRS)
	-for dirX in $^ ; do meson introspect --indent --targets $$dirX/build ; done
	@echo "##### Top-level multiproject: $(parent) #####"
	@echo "       $(MAKE) [SUBDIRS="$(SUBDIRS)"] configure [OPTS=??]"
	@echo "Usage: $(MAKE) [SUBDIRS="$(SUBDIRS)"] [target]"
all: $(SUBDIRS)
	-for dirX in $^ ; do meson compile -C $$dirX/build ; done
#testcompile: $(SUBDIRS)
#	-for dirX in $^ ; do meson compile -C $$dirX/build $@ ; done
check: $(SUBDIRS)
	-for dirX in $^ ; do meson compile -C $$dirX/build $@ ; done
#uninstall: $(SUBDIRS)
#	-for dirX in $^ ; do (cd $$dirX/build ; meson --internal uninstall) ; done
restore nugetadd nugetinstall: $(SUBDIRS)
	-for dirX in $^ ; do meson compile -C $$dirX/build $@ ; done
clean: $(SUBDIRS)
	-for dirX in $^ ; do meson compile -C $$dirX/build --clean ; done
	-rm -fr core* *~ .*~ build/* *.log */*.log

#----------------------------------------
FMTS ?= tar.gz,zip
distdir = $(parent).$(version)

build/$(distdir) : 
	-@mkdir -p build/$(distdir) ; cp -f exclude.lst build/
#	#-zip -9 -q --exclude @exclude.lst -r - . | unzip -od build/$(distdir) -
	-tar --format=posix --dereference --exclude-from=exclude.lst -cf - . | tar -xpf - -C build/$(distdir)

.PHONY: package monodoc lint monocover
package: $(SUBDIRS) | build/$(distdir)
	-@for fmt in `echo $(FMTS) | tr ',' ' '` ; do \
		case $$fmt in \
			7z) echo "### build/$(distdir).7z ###" ; \
				rm -f build/$(distdir).7z ; \
				(cd build ; 7za a -t7z -mx=9 $(distdir).7z $(distdir)) ;; \
			zip) echo "### build/$(distdir).zip ###" ; \
				rm -f build/$(distdir).zip ; \
				(cd build ; zip -9 -q -r $(distdir).zip $(distdir)) ;; \
			*) tarext=`echo $$fmt | grep -e '^tar$$' -e '^tar.xz$$' -e '^tar.zst$$' -e '^tar.bz2$$' || echo tar.gz` ; \
				echo "### build/$(distdir).$$tarext ###" ; \
				rm -f build/$(distdir).$$tarext ; \
				(cd build ; tar --posix -h -caf $(distdir).$$tarext $(distdir)) ;; \
		esac \
	done
	-@rm -r build/$(distdir)
	-for dirX in $^ ; do \
		if [ ! "tar.gz,zip" = "$(FMTS)" ] ; \
			meson configure -Dfmts=$(FMTS) $$dirX/build ; \
		fi ; \
		meson compile -C $$dirX/build package ; \
	done
monodoc lint monocover: $(SUBDIRS)
	-for dirX in $^ ; do meson compile -C $$dirX/build $@ ; done
#run debug valgrind: app
#	-if [ "$(OPTS)" ] ; then \
#		meson configure -Dopts=$(OPTS) app/build ; \
#	fi
#	-meson compile -C app/build $@
